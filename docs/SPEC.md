# FFGViewer 仕様書

> バージョン: 1.0（確定）
> 最終更新: 2026-02-24
> ステータス: ✅ 全事項確定済み

---

## 1. 概要

### 1.1 アプリケーション名

**FFGViewer**

### 1.2 目的

拡張子 `.ffg` で保存された構造解析結果（荷重-変位ヒステリシスデータ）を
グラフとして可視化し、ピーク値の確認・データのエクスポートを支援する
Windows デスクトップアプリケーション。

### 1.3 参考アプリケーション

GraphPostFile FFG Converter V1.0（スクリーンショット参照）

---

## 2. FFGファイル仕様

### 2.1 ファイル形式

| 行番号     | 内容                                      |
|------------|-------------------------------------------|
| 1行目      | 空白行                                    |
| 2行目      | タイトル文字列（シリーズ名として使用）    |
| 3行目〜    | `変位[mm]` `荷重[kN]`（空白区切り）       |
| フッター行 | `-999.0       -999.0`（データ終端マーカー）|

### 2.2 サンプルデータ

```
                                    ← 1行目: 空白行
1.四辺形-パンタmodi                 ← 2行目: タイトル
0.000 0.000                         ← 3行目〜: 変位[mm] 荷重[kN]
0.123 1.456
...
-999.0       -999.0                 ← 終端マーカー（読み込みをここで停止）
```

### 2.3 ファイル読み込みルール

- ファイルの文字コードは **Shift-JIS** として読み込む（`Encoding.GetEncoding("shift_jis")`）
- `-999.0` ペアが現れた行でデータ読み込みを終了する
- タイトル行はグラフ凡例・ピークテーブルのシリーズ名として使用する
- 数値は `double` 型として解析する

### 2.4 シリーズ名の決定ルール

ffg ファイルの 2 行目タイトルからシリーズ名を以下の順序で決定する。

```
① ffg 2行目タイトルを取得
        │
        ▼
② 5文字を超える場合 → 先頭5文字に切り詰める
        │
        ▼
③ 既存シリーズ名と重複する場合 → "_2", "_3", ... の連番サフィックスを付与
        │
        ▼
④ 決定したシリーズ名を使用
```

**例:**

| ffg タイトル       | 切り詰め後  | 既存との重複 | 最終シリーズ名 |
|--------------------|-------------|--------------|----------------|
| `OK`               | `OK`（5文字以内）| なし    | `OK`           |
| `1.四辺形-パンタmodi` | `1.四辺形`  | なし         | `1.四辺形`     |
| `1.四辺形-パンタmodi` | `1.四辺形`  | あり（1つ目） | `1.四辺形_2`  |
| `1.四辺形-ハニカム`   | `1.四辺形`  | あり（2つ目） | `1.四辺形_3`  |

**実装上の注意:**
- 切り詰めは文字単位（バイト単位ではなく）で行う
- 連番は `_2` から始める（1つ目はサフィックスなし）
- 連番の衝突が起きた場合はさらに次の番号を探す（`_2` が既存なら `_3` へ）

---

## 3. 機能要件

### 3.1 ファイル読み込み

| ID    | 機能                         | 詳細                                                                 |
|-------|------------------------------|----------------------------------------------------------------------|
| F-001 | ファイル選択ダイアログ       | 「Open File」ボタンでファイルダイアログを開き `.ffg` を選択          |
| F-002 | GUI へのドラッグ＆ドロップ   | ウィンドウへの D&D でファイル読み込み。既存データへ**重ね書き**      |
| F-003 | アイコンへのドラッグ＆ドロップ| プログラムアイコンへの D&D でアプリ起動＋ファイル読み込み           |
| F-004 | 複数ファイル重ね書き         | 複数の `.ffg` データを同一グラフに色分けして重ねて表示               |
| F-005 | 複数ファイル同時 D&D         | 複数ファイルを一度に D&D した場合、全ファイルを順次読み込む          |

### 3.2 グラフ表示

| ID    | 機能                   | 詳細                                                                         |
|-------|------------------------|------------------------------------------------------------------------------|
| F-010 | 荷重-変位グラフ描画    | X 軸: 変位 [mm]、Y 軸: 荷重 [kN] のライングラフ                             |
| F-011 | ピーク点マーキング     | 各シリーズの荷重最大・最小点を、**そのシリーズと同色の点（●）** でグラフ上に表示 |
| F-012 | 凡例表示               | 各シリーズ名をグラフ**描画領域内**に凡例として表示（グラフ外には出さない）   |
| F-013 | パン（移動）           | ドラッグでグラフ表示領域を移動                                               |
| F-014 | ズーム                 | マウスホイール or ドラッグ選択でズームイン/アウト                            |
| F-015 | 軸タイトル編集         | X 軸・Y 軸のタイトル文字列を入力欄で変更可能（デフォルト値あり）             |
| F-016 | シリーズ色自動割り当て | 複数シリーズをカラーパレットで自動的に色分け（線・ピーク点を同色に統一）     |
| F-017 | 軸範囲自動調整         | ファイル読み込み時に X 軸・Y 軸の表示範囲を全シリーズのデータに合わせて自動調整 |

**軸タイトルデフォルト値:**
- X 軸: `Disp. [mm]`
- Y 軸: `Load [kN]`

**F-016 色分けルール:**

```
シリーズ 1: ─────  ● （色A）
シリーズ 2: ─────  ● （色B）
シリーズ 3: ─────  ● （色C）
              ↑          ↑
           折れ線     ピーク点
         （同色で統一）
```

- カラーパレット: LiveCharts2 のデフォルトパレットを使用（循環割り当て）
- ピーク点マーカーの色は折れ線と同色とし、区別はマーカー形状（●実線円）で行う

**F-017 軸範囲自動調整の動作:**

```
[新規ファイル読み込み]
        │
        ▼
全シリーズの Disp/Load の min・max を再計算
        │
        ▼
X 軸: min(Disp) 〜 max(Disp)  に余白（±10%）を加えて設定
Y 軸: min(Load) 〜 max(Load)  に余白（±10%）を加えて設定
        │
        ▼
グラフ表示範囲を更新（パン・ズーム後の状態はリセット）
```

**F-012 凡例位置:**
- 凡例はグラフ描画領域の**右上内側**に配置（LiveCharts2 の `LegendPosition.Right` または `TopRight` を使用）
- シリーズが多い場合はスクロール対応

### 3.3 ピークデータ表示

| ID    | 機能                   | 詳細                                                            |
|-------|------------------------|-----------------------------------------------------------------|
| F-020 | ピーク値一覧表示       | 各シリーズの荷重最大・最小値と対応変位を表形式で表示            |
| F-021 | クリップボードコピー   | 「PeakData Copy to ClipBoard」ボタンでタブ区切りテキストとしてコピー |

**ピーク表示テーブル構造:**

| Name                         | (+/-) | Load [kN]  | Disp. [mm] |
|------------------------------|-------|------------|------------|
| 🔵 1.四辺形-パンタmodi （色A）| (+)   | 121.7380   | 7.3127     |
| 🔵 1.四辺形-パンタmodi （色A）| (-)   | -92.4609   | -5.2706    |
| 🟠 Series2     （色B）        | (+)   | ...        | ...        |
| 🟠 Series2     （色B）        | (-)   | ...        | ...        |

**Name 列の色付きテキスト表示:**
- `Name` 列のテキスト色をそのシリーズに割り当てたグラフ線の色と同色にする
- 実装: `DataGrid` の `CellStyle` で `Foreground` をシリーズ色にバインド
- クリップボードコピー時はプレーンテキスト（色情報なし）でコピー

**クリップボードコピー形式（タブ区切りテキスト）:**

```
Name	(+/-)	Load [kN]	Disp. [mm]
1.四辺形-パンタmodi	(+)	121.7380	7.3127
1.四辺形-パンタmodi	(-)	-92.4609	-5.2706
```

### 3.4 データエクスポート

| ID    | 機能              | 詳細                                                                        |
|-------|-------------------|-----------------------------------------------------------------------------|
| F-030 | Excel エクスポート | ボタン押下で現在読み込み中の全データを `.xlsx` 出力（数値データ＋グラフ）   |
| F-031 | CSV エクスポート   | ボタン押下で現在読み込み中の全データを `.csv` 出力                          |

**Excel エクスポート仕様:**

| シート名           | 内容                                              |
|--------------------|---------------------------------------------------|
| `Data_[シリーズ名]`| 変位・荷重の数値データ列（ヘッダー行あり）        |
| `PeakData`         | ピーク値一覧（F-020 のテーブルと同内容）          |
| `Graph`            | 全シリーズを含む**散布図（XY チャート）**（Excel グラフオブジェクト）|

**Excel データシート列構造:**

| 列 A          | 列 B        |
|---------------|-------------|
| Disp. [mm]    | Load [kN]   |
| 0.000         | 0.000       |
| ...           | ...         |

**CSV エクスポート仕様:**

複数シリーズが読み込まれている場合、**1ファイルに全シリーズを列として並べて出力**する。

| 列 A          | 列 B        | 列 C            | 列 D          | ...  |
|---------------|-------------|-----------------|---------------|------|
| Disp_Series1  | Load_Series1| Disp_Series2    | Load_Series2  | ...  |
| 0.000         | 0.000       | 0.000           | 0.000         | ...  |
| ...           | ...         | ...             | ...           | ...  |

- ヘッダー行: `Disp_[シリーズ名], Load_[シリーズ名]` の形式
- シリーズ間でデータ点数が異なる場合は短い方を空白で埋める
- 出力ファイル名: 保存ダイアログで指定（デフォルト: 最初に読み込んだファイル名 + `.csv`）

### 3.5 その他

| ID    | 機能             | 詳細                                         |
|-------|------------------|----------------------------------------------|
| F-040 | グラフクリア     | 「Clear Graph」ボタンで全シリーズを一括クリア |
| F-041 | About ダイアログ | アプリ名・バージョン情報を表示               |
| F-042 | ステータスバー   | ファイル読み込み状況・エラーメッセージ等を表示|

---

## 4. 非機能要件

| ID     | 項目             | 要件                                            |
|--------|------------------|-------------------------------------------------|
| NF-001 | プラットフォーム | Windows 10 / 11                                 |
| NF-002 | フレームワーク   | .NET 8.0（WPF）                                 |
| NF-003 | パフォーマンス   | 数万点データでもスムーズなグラフ描画・スクロール|
| NF-004 | ファイル対応     | `.ffg` ファイルのみサポート                      |
| NF-005 | エラーハンドリング| 不正ファイル・読み込みエラーをステータスバーに表示|

---

## 5. UI 仕様

### 5.1 レイアウト概要

```
┌──────────────────────────────────────────────────────────────┐
│  FFGViewer                           [－][□][×]              │
├──────────────────────────────────────────────────────────────┤
│  [Open File]  [ファイルパス表示（伸縮）              ]  [Clear Graph]│
├────────────────────────────────────┬─────────────────────────┤
│  ↕ウィンドウに合わせて伸縮         │  ← 固定幅（約280px）    │
│                                    │ ┌───────────────────┐   │
│                                    │ │Name│(+/-)│Load│Disp│  │
│    グラフ描画エリア ←伸縮→        │ │────│─────│────│────│  │
│    LiveCharts2                     │ │S1  │(+)  │121 │7.3 │  │
│    （パン・ズーム対応）             │ │S1  │(-)  │-92 │-5.2│  │
│                                    │ └───────────────────┘   │
│                                    │ [PeakData Copy to CB]   │
│                                    │                         │
│                                    │ X Title:[Disp. [mm]  ]  │
│                                    │ Y Title:[Load [kN]   ]  │
│                                    │                         │
│                                    │ [Export to Excel]       │
│                                    │ [Export to CSV]         │
│                                    │           [About...]    │
├────────────────────────────────────┴─────────────────────────┤
│  ステータスバー: 1.四辺形-パンタmodi.ffg was Dropped!         │
└──────────────────────────────────────────────────────────────┘
```

### 5.1.1 レスポンシブレイアウト仕様

```
ウィンドウリサイズ時の挙動
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
 要素                     │ リサイズ時の挙動
──────────────────────────┼──────────────────────
 グラフ描画エリア          │ ✅ 幅・高さとも伸縮
 ヘッダーバー（ツールバー）│ ✅ 幅のみ伸縮（高さ固定）
 ファイルパス表示欄        │ ✅ 幅のみ伸縮
 右パネル（コントロール）  │ ❌ 固定幅（約280px）
 ピークデータ表            │ ❌ 固定サイズ
 各ボタン                 │ ❌ 固定サイズ
 ステータスバー            │ ✅ 幅のみ伸縮（高さ固定）
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

**WPF Grid による実装方針:**

```xml
<!-- メインレイアウト -->
<Grid>
    <Grid.ColumnDefinitions>
        <ColumnDefinition Width="*" />        <!-- グラフ: 伸縮 -->
        <ColumnDefinition Width="280" />      <!-- 右パネル: 固定 -->
    </Grid.ColumnDefinitions>
    <Grid.RowDefinitions>
        <RowDefinition Height="Auto" />       <!-- ツールバー: 固定 -->
        <RowDefinition Height="*" />          <!-- メイン: 伸縮 -->
        <RowDefinition Height="Auto" />       <!-- ステータス: 固定 -->
    </Grid.RowDefinitions>
</Grid>
```

- `Width="*"` によりグラフエリアがウィンドウ幅の残余をすべて占有する
- 右パネルは `Width="280"` 固定で、ボタン・表のサイズはウィンドウに依存しない
- `CartesianChart` 自身は親コンテナ（`*` 列）に合わせて自動伸縮する

### 5.2 カラースキーム

**モダン・フラットデザイン**を採用する（オレンジ系は踏襲しない）。

```
ライトテーマ（固定）
─────────────────────────────────────────────
  背景:          #F5F5F5（薄グレー）
  カード/パネル: #FFFFFF（白）
  アクセント:    #1976D2（マテリアルブルー）
  ボタン背景:    #1976D2（ブルー）
  ボタン文字:    #FFFFFF（白）
  セカンダリ:    #E3F2FD（薄ブルー）
  テキスト主:    #212121
  テキスト副:    #757575
  ボーダー:      #E0E0E0
  グラフ背景:    #FFFFFF
  グリッド線:    #EEEEEE
─────────────────────────────────────────────
```

| 要素               | カラー             |
|--------------------|--------------------|
| ウィンドウ背景     | `#F5F5F5`          |
| パネル背景         | `#FFFFFF`          |
| ボタン（主要）背景 | `#1976D2`          |
| ボタン文字         | `#FFFFFF`          |
| アクセント色       | `#1976D2`          |
| グラフ背景         | `#FFFFFF`          |
| グリッド線         | `#EEEEEE`          |
| ステータスバー背景 | `#ECEFF1`          |

### 5.3 各コントロール仕様

| コントロール         | 種類             | バインド先 (ViewModel)      |
|----------------------|------------------|-----------------------------|
| Open File ボタン     | Button           | `OpenFileCommand`           |
| ファイルパス表示     | TextBox（読み取り専用）| `CurrentFilePath`（最後に読み込んだファイルのパスを表示）|
| Clear Graph ボタン   | Button           | `ClearGraphCommand`         |
| グラフ               | CartesianChart   | `Series`                    |
| ピークデータ表         | DataGrid         | `PeakDataItems`             |
| PeakData Copy ボタン | Button           | `CopyPeakDataCommand`       |
| X Axis Title         | TextBox          | `XAxisTitle`                |
| Y Axis Title         | TextBox          | `YAxisTitle`                |
| Export to Excel      | Button           | `ExportExcelCommand`        |
| Export to CSV        | Button           | `ExportCsvCommand`          |
| About ボタン         | Button           | `ShowAboutCommand`          |
| ステータスバー       | TextBlock        | `StatusMessage`             |

---

## 6. 技術スタック

| 種別                 | 採用技術                                      |
|----------------------|-----------------------------------------------|
| UI フレームワーク    | WPF (.NET 8)                                  |
| アーキテクチャ       | MVVM                                          |
| リアクティブ         | ReactiveProperty (ReactivePropertySlim)       |
| グラフライブラリ     | LiveCharts2 (`LiveChartsCore.SkiaSharpView.WPF`) |
| Excel 出力           | ClosedXML（ライセンス: MIT）                  |
| DI コンテナ          | Microsoft.Extensions.DependencyInjection      |

---

## 7. アーキテクチャ（MVVM 構成）

### 7.1 プロジェクト構成

```
FFGViewer/
├── App.xaml                    # アプリエントリポイント・D&D起動対応
├── App.xaml.cs
├── Models/
│   ├── DataPoint.cs            # 変位・荷重の1点データ
│   ├── FfgData.cs              # 1ファイル分のデータ（タイトル＋点列）
│   └── PeakData.cs             # ピーク値データ（最大・最小）
├── ViewModels/
│   └── MainViewModel.cs        # メイン画面 ViewModel
├── Views/
│   └── MainWindow.xaml         # メイン画面 View
├── Services/
│   ├── IFfgFileService.cs      # ファイル読み込みインターフェース
│   ├── FfgFileService.cs       # ffg ファイル読み込み実装
│   ├── IExcelExportService.cs
│   ├── ExcelExportService.cs   # Excel エクスポート実装
│   ├── ICsvExportService.cs
│   └── CsvExportService.cs     # CSV エクスポート実装
└── Resources/
    └── AppIcon.ico             # アプリケーションアイコン
```

### 7.2 主要クラス定義

#### Models/DataPoint.cs

```csharp
public class DataPoint
{
    public double Displacement { get; init; }  // 変位 [mm]
    public double Load { get; init; }          // 荷重 [kN]
}
```

#### Models/PeakData.cs

```csharp
public class PeakData
{
    public string SeriesName { get; init; }
    public double MaxLoad { get; init; }
    public double MaxLoadDisplacement { get; init; }
    public double MinLoad { get; init; }
    public double MinLoadDisplacement { get; init; }
}
```

#### Models/FfgData.cs

```csharp
public class FfgData
{
    public string Title { get; init; }
    public string FilePath { get; init; }
    public IReadOnlyList<DataPoint> DataPoints { get; init; }
    public PeakData PeakData { get; init; }
}
```

#### ViewModels/MainViewModel.cs（骨子）

```csharp
public class MainViewModel : INotifyPropertyChanged
{
    // コマンド
    public ReactiveCommandSlim OpenFileCommand { get; }
    public ReactiveCommandSlim ClearGraphCommand { get; }
    public ReactiveCommandSlim CopyPeakDataCommand { get; }
    public ReactiveCommandSlim ExportExcelCommand { get; }
    public ReactiveCommandSlim ExportCsvCommand { get; }
    public ReactiveCommandSlim ShowAboutCommand { get; }

    // グラフデータ
    public ObservableCollection<ISeries> Series { get; }
    public ObservableCollection<Axis> XAxes { get; }
    public ObservableCollection<Axis> YAxes { get; }

    // ピークデータ
    public ObservableCollection<PeakDataRow> PeakDataItems { get; }

    // 軸タイトル
    public ReactivePropertySlim<string> XAxisTitle { get; }
    public ReactivePropertySlim<string> YAxisTitle { get; }

    // ステータス
    public ReactivePropertySlim<string> StatusMessage { get; }
    public ReactivePropertySlim<string> CurrentFilePath { get; }
}
```

### 7.3 依存関係図

```
MainWindow.xaml
    │ DataBinding
    ▼
MainViewModel
    ├── FfgFileService      (ffg ファイル解析)
    ├── ExcelExportService  (xlsx 出力)
    └── CsvExportService    (csv 出力)
```

---

## 8. ドラッグ＆ドロップ実装方針

### 8.1 GUI ウィンドウへの D&D

```
MainWindow.xaml
    AllowDrop="True"
    Drop="OnDrop"
    DragOver="OnDragOver"
```

- `e.Data.GetData(DataFormats.FileDrop)` でファイルパス配列を取得
- 複数ファイルを一度にドロップ可能
- `.ffg` 以外は無視してステータスバーに警告表示

### 8.2 プログラムアイコンへの D&D（起動時引数）

```csharp
// App.xaml.cs
protected override void OnStartup(StartupEventArgs e)
{
    base.OnStartup(e);
    // e.Args にドロップされたファイルパスが渡される
    if (e.Args.Length > 0)
    {
        // ViewModel にファイルパスを渡して読み込み
    }
}
```

---

## 9. コマンドライン引数

```
FFGViewer.exe [filePath1] [filePath2] ...
```

プログラムアイコンへの D&D により、起動引数としてファイルパスが渡される。
複数ファイルのまとめてのドロップにも対応する。

---

## 10. エクスポート詳細仕様

### 10.1 Excel エクスポート（ClosedXML 使用）

**出力ファイル名:** 保存ダイアログで指定（デフォルト: 最初に読み込んだファイル名 + `.xlsx`）

**シート構成:**

```
WorkBook
├── Sheet: "PeakData"       ← ピーク値一覧
├── Sheet: "Data_[Series1]" ← シリーズ1の変位・荷重数値
├── Sheet: "Data_[Series2]" ← シリーズ2（複数読み込み時）
└── Sheet: "Graph"          ← Excel グラフオブジェクト（全シリーズ含む）
```

**Data シートのレイアウト:**

| A           | B         |
|-------------|-----------|
| Disp. [mm]  | Load [kN] |
| 0.000       | 0.000     |
| ...         | ...       |

### 10.2 CSV エクスポート

**出力ファイル名:** 保存ダイアログで指定（デフォルト: 最初に読み込んだファイル名 + `.csv`）

**出力形式:** 1ファイルに全シリーズを列として並べて出力する。

| Disp_Series1 | Load_Series1 | Disp_Series2 | Load_Series2 | ... |
|--------------|--------------|--------------|--------------|-----|
| 0.000        | 0.000        | 0.000        | 0.000        | ... |
| ...          | ...          | ...          | ...          | ... |

- ヘッダー行: `Disp_[シリーズ名], Load_[シリーズ名]` の形式
- シリーズ間でデータ点数が異なる場合は短い方を空白セルで埋める
- 区切り文字: カンマ (`,`)

---

## 11. エラーハンドリング

| エラー種別               | 処理                                              |
|--------------------------|---------------------------------------------------|
| 非 `.ffg` ファイルのD&D  | ステータスバーに「非対応ファイル形式です」と表示  |
| ファイル読み込み失敗     | ステータスバーにエラー内容を表示、グラフは変更しない|
| データが0件              | ステータスバーに「データが見つかりません」と表示  |
| エクスポート失敗         | メッセージボックスでエラーを通知                  |

---

## 12. 確定事項まとめ

| No. | 項目                       | 決定内容                                           |
|-----|----------------------------|----------------------------------------------------|
| Q1  | CSV エクスポート形式        | 1ファイルに全シリーズを列として並べる              |
| Q2  | Clear Graph の動作         | 全シリーズ一括クリアのみ                           |
| Q3  | カラースキーム              | モダン・フラットデザイン（マテリアルブルー系）     |
| Q4  | .NET バージョン            | .NET 8.0                                           |
| Q5  | Excel エクスポート内容     | 数値データシート＋散布図グラフシート＋PeakData シート|
| Q6  | ffg ファイル文字コード     | Shift-JIS                                          |
| Q7  | Excel グラフ種類           | 散布図（XY チャート）                              |
| Q8  | ピークテーブル Name 列     | シリーズと同色の色付きテキストで表示               |
| Q9  | 複数ファイル時のパス表示欄 | 最後に読み込んだファイルのパスを表示               |

---

## 13. テスト方針

### 13.1 基本姿勢

- **振る舞いテスト**: 実装詳細ではなく、仕様に定義された振る舞いをテストする
- **独立性**: テスト間の依存を持たせず、任意の順序で実行可能にする
- **エッジケース必須**: 正常系だけでなく、異常系・境界値・空データを必ずカバーする
- **モックは最小限**: 本物のロジックに近い形でテストし、必要な箇所のみモック化

### 13.2 テスト対象とスコープ

```
テスト対象の範囲
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
 レイヤー        テスト方針
──────────────── ────────────────────────────────────
 Models          ロジックなし → テスト不要
 Services        ✅ 単体テスト（UIに非依存・最重要）
 ViewModels      ✅ 単体テスト（Serviceをモック化）
 Views（XAML）   ❌ スコープ外（UIテストは対象外）
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

### 13.3 テストプロジェクト構成

```
FFGViewer.sln
├── FFGViewer/                          ← 本体
└── FFGViewer.Tests/                    ← テストプロジェクト（xUnit）
    ├── Services/
    │   ├── FfgFileServiceTests.cs        ファイル解析ロジックのテスト
    │   ├── CsvExportServiceTests.cs      CSV出力ロジックのテスト
    │   └── ExcelExportServiceTests.cs    Excel出力ロジックのテスト
    ├── ViewModels/
    │   └── MainViewModelTests.cs         シリーズ名解決・ピーク計算・コマンドのテスト
    ├── TestData/                         実際の .ffg テストファイル（バイナリではなくテキスト）
    │   ├── normal_short_title.ffg        タイトル5文字以内の正常ケース
    │   ├── long_title.ffg                タイトル6文字以上（切り詰めテスト用）
    │   ├── empty_data.ffg                データ0件（フッターのみ）
    │   ├── single_point.ffg              データ1点のみ（ピーク計算の境界値）
    │   └── invalid_format.ffg            不正フォーマット（エラーハンドリングテスト用）
    └── Helpers/
        └── FfgDataBuilder.cs             テスト用データ生成ヘルパー（Builder パターン）
```

### 13.4 採用パッケージ

| パッケージ                    | 用途                                      |
|-------------------------------|-------------------------------------------|
| `xunit`                       | テストフレームワーク                      |
| `xunit.runner.visualstudio`   | Visual Studio / dotnet test 統合          |
| `Moq`                         | サービス・依存関係のモック作成            |
| `FluentAssertions`            | 読みやすいアサーション記法                |

### 13.5 テストケース一覧

#### FfgFileServiceTests（Services/FfgFileServiceTests.cs）

| テストケース名                                       | 分類       |
|------------------------------------------------------|------------|
| 正常なffgファイルを読み込んでDataPointsを返す         | 正常系     |
| Shift-JIS の日本語タイトルを正しく読み込む           | 正常系     |
| フッター行（-999.0）でデータ読み込みが終了する        | 正常系     |
| タイトルが5文字以内のときそのまま返す                | 境界値     |
| タイトルがちょうど5文字のときそのまま返す            | 境界値     |
| タイトルが6文字以上のとき先頭5文字に切り詰める       | 境界値     |
| データが0件（フッターのみ）のとき空リストを返す      | エッジケース|
| データが1点のみのときそのデータを返す                | エッジケース|
| フッター行より前の行のみをデータとして返す           | 正常系     |
| 存在しないファイルパスのとき例外をスローする         | 異常系     |
| 不正フォーマット（数値以外）のとき例外をスローする   | 異常系     |

#### MainViewModelTests（ViewModels/MainViewModelTests.cs）

| テストケース名                                             | 分類       |
|------------------------------------------------------------|------------|
| 初回読み込み時シリーズ名にサフィックスなしで追加される     | 正常系     |
| 同名シリーズを2回読み込むと2件目に _2 が付与される         | 正常系     |
| 同名シリーズを3回読み込むと3件目に _3 が付与される         | 正常系     |
| 異なるタイトルが同じ5文字に切り詰まる場合も連番で区別される| エッジケース|
| ピーク最大荷重と最大時変位が正しく計算される               | 正常系     |
| ピーク最小荷重と最小時変位が正しく計算される               | 正常系     |
| データ1点のとき最大・最小が同値になる                      | 境界値     |
| ClearGraph 後に Series が空になる                          | 正常系     |
| ClearGraph 後に PeakDataItems が空になる                   | 正常系     |
| データ未読込時に ExportExcel コマンドが実行不可            | 正常系     |
| データ未読込時に ExportCsv コマンドが実行不可              | 正常系     |
| データ読込後に ExportExcel コマンドが実行可能              | 正常系     |
| ClearGraph 後に Export コマンドが再び実行不可になる        | 正常系     |

#### CsvExportServiceTests（Services/CsvExportServiceTests.cs）

| テストケース名                                               | 分類       |
|--------------------------------------------------------------|------------|
| 1シリーズ時のヘッダーが Disp_[名], Load_[名] の形式になる    | 正常系     |
| 1シリーズのデータが正しい行数で出力される                    | 正常系     |
| 2シリーズ時に列が横に並んで出力される                        | 正常系     |
| シリーズ間でデータ点数が異なる場合に短い方が空で埋められる   | エッジケース|
| 区切り文字がカンマである                                     | 正常系     |
| データ0件のとき（ClearGraph後）エクスポートが呼ばれない      | 異常系     |

#### ExcelExportServiceTests（Services/ExcelExportServiceTests.cs）

| テストケース名                                              | 分類   |
|-------------------------------------------------------------|--------|
| 出力ファイルに Data_[シリーズ名] シートが存在する           | 正常系 |
| Data シートの1行目がヘッダー（Disp. [mm], Load [kN]）である | 正常系 |
| 出力ファイルに PeakData シートが存在する                    | 正常系 |
| PeakData シートにピーク値が正しく記載される                 | 正常系 |
| 出力ファイルに Graph シートが存在する                       | 正常系 |
| 複数シリーズ時にシリーズ数分の Data シートが存在する        | 正常系 |

### 13.6 テストコード規約

```csharp
// ✅ テストメソッド名: 「状況_操作_期待結果」または日本語で「〜のとき〜になる」形式
[Fact]
public void タイトルが6文字以上のとき先頭5文字に切り詰められる()
{
    // Arrange（準備）
    var service = new FfgFileService();

    // Act（操作）
    var result = service.Load("TestData/long_title.ffg");

    // Assert（検証）
    result.Title.Should().HaveLength(5);
}

// ✅ パラメータ化テストで境界値を網羅
[Theory]
[InlineData("ABCDE",    "ABCDE")]   // 5文字: そのまま
[InlineData("ABCDEF",   "ABCDE")]   // 6文字: 切り詰め
[InlineData("1.四辺形-パンタ", "1.四辺形")]  // 日本語含む
public void タイトル長に応じて正しくシリーズ名が決定される(
    string rawTitle, string expectedName)
{
    // ...
}
```

**禁止事項（グローバルルール準拠）:**
- `skip`, `xit`, `xdescribe` 等によるテストのスキップを放置しない
- `Assert.True(true)` のような意味のないアサーションを書かない
- テストを通すためだけのハードコードをしない
- 本番コードに `if (isTestMode)` のような条件分岐を入れない

---

*作成: Claude Code (claude-sonnet-4-6)*
