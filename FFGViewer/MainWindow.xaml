<Window x:Class="FFGViewer.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:vm="clr-namespace:FFGViewer.ViewModels"
        xmlns:conv="clr-namespace:FFGViewer.Resources.Converters"
        mc:Ignorable="d"
        Title="FFGViewer" Height="600" Width="1000" MinWidth="700" MinHeight="400"
        AllowDrop="True"
        DragOver="Window_DragOver"
        Drop="Window_Drop">

    <Window.Resources>
        <ResourceDictionary>
            <ResourceDictionary.MergedDictionaries>
                <ResourceDictionary Source="Resources/Colors.xaml"/>
                <ResourceDictionary Source="Resources/Styles/ButtonStyles.xaml"/>
                <ResourceDictionary Source="Resources/Styles/DataGridStyles.xaml"/>
            </ResourceDictionary.MergedDictionaries>
            <conv:ColorToBrushConverter x:Key="ColorToBrushConverter"/>
        </ResourceDictionary>
    </Window.Resources>

    <Grid Background="{StaticResource BackgroundGrayBrush}">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <!-- Row 0: ToolBar -->
        <Border Grid.Row="0" Background="{StaticResource ToolbarBgBrush}"
                BorderBrush="#FFBBDEFB" BorderThickness="0,0,0,1" Padding="8,6">
            <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                <Button Content="ファイルを開く" Style="{StaticResource PrimaryButton}"
                        Command="{Binding OpenFileCommand}"/>
                <Button Content="グラフクリア" Style="{StaticResource DangerButton}"
                        Command="{Binding ClearGraphCommand}"/>
                <TextBlock Text="ファイル: " VerticalAlignment="Center" Margin="12,0,4,0"
                           Foreground="{StaticResource TextSecondaryBrush}" FontSize="12"/>
                <TextBlock Text="{Binding CurrentFilePath.Value}" VerticalAlignment="Center"
                           MaxWidth="600" TextTrimming="CharacterEllipsis"
                           Foreground="{StaticResource TextPrimaryBrush}" FontSize="12"/>
            </StackPanel>
        </Border>

        <!-- Row 1: Main area -->
        <Grid Grid.Row="1">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="280"/>
            </Grid.ColumnDefinitions>

            <!-- Chart host (CartesianChart injected in code-behind) -->
            <Grid x:Name="ChartHost" Grid.Column="0" Margin="8"/>

            <!-- Right Panel -->
            <Border Grid.Column="1" Background="White"
                    BorderBrush="#FFB0BEC5" BorderThickness="1,0,0,0" Padding="8">
                <DockPanel>
                    <!-- Buttons at bottom -->
                    <StackPanel DockPanel.Dock="Bottom" Margin="0,8,0,0">
                        <Separator Margin="0,4"/>
                        <CheckBox Content="間引き表示"
                                  IsChecked="{Binding IsDecimationEnabled.Value}"
                                  IsEnabled="{Binding CanToggleDecimation.Value}"
                                  Margin="0,4,0,8" FontSize="12"
                                  ToolTip="データ数が15,000点を超えるシリーズをLTTBアルゴリズムで間引いて表示します&#x0a;ピーク計算・エクスポートは元データを使用します"/>
                        <Separator Margin="0,4"/>
                        <TextBlock Text="軸タイトル" FontWeight="Bold" FontSize="12"
                                   Foreground="{StaticResource PrimaryBlueBrush}" Margin="0,4,0,2"/>
                        <TextBlock Text="X軸:" FontSize="11" Margin="0,2,0,1"/>
                        <TextBox Text="{Binding XAxisTitle.Value, UpdateSourceTrigger=PropertyChanged}"
                                 Margin="0,0,0,4" Padding="4,2" FontSize="12"/>
                        <TextBlock Text="Y軸:" FontSize="11" Margin="0,2,0,1"/>
                        <TextBox Text="{Binding YAxisTitle.Value, UpdateSourceTrigger=PropertyChanged}"
                                 Margin="0,0,0,8" Padding="4,2" FontSize="12"/>
                        <Button Content="ピークデータをコピー" Style="{StaticResource SecondaryButton}"
                                HorizontalAlignment="Stretch"
                                Command="{Binding CopyPeakDataCommand}"/>
                        <Button Content="Excel エクスポート" Style="{StaticResource PrimaryButton}"
                                HorizontalAlignment="Stretch"
                                Command="{Binding ExportExcelCommand}"/>
                        <Button Content="CSV エクスポート" Style="{StaticResource SecondaryButton}"
                                HorizontalAlignment="Stretch"
                                Command="{Binding ExportCsvCommand}"/>
                    </StackPanel>

                    <!-- Peak Data Table -->
                    <ScrollViewer VerticalScrollBarVisibility="Auto">
                        <StackPanel>
                            <TextBlock Text="ピークデータ" FontWeight="Bold" FontSize="13"
                                       Foreground="{StaticResource PrimaryBlueBrush}" Margin="0,0,0,6"/>
                            <DataGrid ItemsSource="{Binding PeakDataItems}"
                                      Style="{StaticResource PeakDataGrid}"
                                      SelectionMode="Single">
                                <DataGrid.Columns>
                                    <DataGridTemplateColumn Header="シリーズ" Width="*">
                                        <DataGridTemplateColumn.CellTemplate>
                                            <DataTemplate DataType="{x:Type vm:PeakDataRow}">
                                                <TextBlock Text="{Binding SeriesName}"
                                                           Foreground="{Binding SeriesColor, Converter={StaticResource ColorToBrushConverter}}"
                                                           FontWeight="Bold" Padding="4,2"/>
                                            </DataTemplate>
                                        </DataGridTemplateColumn.CellTemplate>
                                    </DataGridTemplateColumn>
                                    <DataGridTextColumn Header="符号" Binding="{Binding Sign}" Width="40"/>
                                    <DataGridTextColumn Header="荷重" Binding="{Binding Load, StringFormat=F2}" Width="60"/>
                                    <DataGridTextColumn Header="変位" Binding="{Binding Displacement, StringFormat=F2}" Width="60"/>
                                </DataGrid.Columns>
                            </DataGrid>
                        </StackPanel>
                    </ScrollViewer>
                </DockPanel>
            </Border>
        </Grid>

        <!-- Row 2: StatusBar -->
        <Border Grid.Row="2" Background="{StaticResource StatusBarBgBrush}"
                BorderBrush="#FFBBDEFB" BorderThickness="0,1,0,0" Padding="8,4">
            <TextBlock Text="{Binding StatusMessage.Value}" FontSize="12"
                       Foreground="{StaticResource TextPrimaryBrush}"/>
        </Border>
    </Grid>
</Window>
